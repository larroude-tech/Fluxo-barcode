# GitHub Actions workflow to build and push the Fluxo Barcode Docker image to
# Google Artifact Registry (or Container Registry). Requires the following
# repository secrets:
#   GCP_PROJECT_ID        → GCP project that hosts the registry
#   GCP_REGION            → e.g. southamerica-east1 (must match Artifact Registry)
#   GCP_SA_KEY            → JSON service account key with Artifact Registry Writer
#   ARTIFACT_REPOSITORY   → Artifact Registry repo (e.g. fluxo-images)
#   DATABASE_URL or PGHOST / PGUSER / PGPASSWORD / PGDATABASE (optional for deploy)
#
# Example deploy command (Cloud Run):
#   gcloud run deploy fluxo-barcode --image "$IMAGE_URI" --region "$GCP_REGION" \
#     --set-env-vars DATABASE_URL=$DATABASE_URL ...

name: Build & Push Docker image

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: fluxo-barcode
  DEFAULT_GCP_PROJECT_ID: larroude-data-prod
  DEFAULT_GCP_REGION: us-central1
  DEFAULT_ARTIFACT_REPOSITORY: cloud-run

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    env:
      GCP_REGION: ${{ secrets.GCP_REGION }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      ARTIFACT_REPOSITORY: ${{ secrets.ARTIFACT_REPOSITORY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          REGION="${GCP_REGION:-$DEFAULT_GCP_REGION}"
          echo "EFFECTIVE_GCP_REGION=${REGION}" >> $GITHUB_ENV
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build Docker image
        run: |
          REGION="${GCP_REGION:-$DEFAULT_GCP_REGION}"
          PROJECT_ID="${GCP_PROJECT_ID:-$DEFAULT_GCP_PROJECT_ID}"
          REPOSITORY="${ARTIFACT_REPOSITORY:-$DEFAULT_ARTIFACT_REPOSITORY}"
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE_NAME}:${IMAGE_TAG}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV
          docker build -t "${IMAGE_URI}" .

      - name: Push image to Artifact Registry
        run: |
          docker push "${IMAGE_URI}"

      - name: Prepare Cloud Run secrets
        id: prepare_secrets
        run: |
          SECRETS=""
          [ -n "${{ secrets.DATABASE_URL }}" ] && SECRETS="${SECRETS}DATABASE_URL=${{ secrets.DATABASE_URL }}:latest"$'\n'
          [ -n "${{ secrets.PGHOST }}" ] && SECRETS="${SECRETS}PGHOST=${{ secrets.PGHOST }}:latest"$'\n'
          [ -n "${{ secrets.PGPORT }}" ] && SECRETS="${SECRETS}PGPORT=${{ secrets.PGPORT }}:latest"$'\n'
          [ -n "${{ secrets.PGUSER }}" ] && SECRETS="${SECRETS}PGUSER=${{ secrets.PGUSER }}:latest"$'\n'
          [ -n "${{ secrets.PGPASSWORD }}" ] && SECRETS="${SECRETS}PGPASSWORD=${{ secrets.PGPASSWORD }}:latest"$'\n'
          [ -n "${{ secrets.PGDATABASE }}" ] && SECRETS="${SECRETS}PGDATABASE=${{ secrets.PGDATABASE }}:latest"$'\n'
          echo "secrets<<EOF" >> $GITHUB_OUTPUT
          echo -n "${SECRETS}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ secrets.CLOUD_RUN_SERVICE || env.IMAGE_NAME }}
          region: ${{ env.EFFECTIVE_GCP_REGION || env.DEFAULT_GCP_REGION }}
          image: ${{ env.IMAGE_URI }}
          project_id: ${{ secrets.GCP_PROJECT_ID || env.DEFAULT_GCP_PROJECT_ID }}
          env_vars: |
            NODE_ENV=production
          secrets: ${{ steps.prepare_secrets.outputs.secrets }}
          flags: '--service-account=data-github-integration@larroude-data-prod.iam.gserviceaccount.com --timeout=300 --cpu=1 --memory=512Mi --allow-unauthenticated'

      - name: Export deployment info
        run: |
          REGION="${GCP_REGION:-$DEFAULT_GCP_REGION}"
          echo "Imagem publicada e deploy concluído:"
          echo "  Serviço: ${{ secrets.CLOUD_RUN_SERVICE || env.IMAGE_NAME }}"
          echo "  Região:  ${REGION}"

