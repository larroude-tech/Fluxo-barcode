name: Extrair Google Drive para o repositório

on:
  workflow_dispatch: # permite rodar manualmente
  schedule:
    - cron: "0 6 * * *" # opcional: todos os dias às 06:00 UTC

permissions:
  contents: write # necessário para comitar alterações

jobs:
  sync-drive-to-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Instalar rclone e jq
        run: |
          sudo -n apt-get update
          sudo -n apt-get install -y rclone jq

      - name: Validar e escrever chave da Service Account
        run: |
          if [ -z "${GDRIVE_SERVICE_ACCOUNT_JSON}" ]; then
            echo "❌ Erro: GDRIVE_SERVICE_ACCOUNT_JSON secret não está configurado ou está vazio"
            exit 1
          fi
          
          # Validar se é um JSON válido
          echo "${GDRIVE_SERVICE_ACCOUNT_JSON}" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ Erro: GDRIVE_SERVICE_ACCOUNT_JSON não é um JSON válido"
            exit 1
          fi
          
          # Escrever arquivo da service account
          echo "${GDRIVE_SERVICE_ACCOUNT_JSON}" > /home/runner/work/service-account.json
          
          # Validar que o arquivo foi criado corretamente
          if [ ! -f /home/runner/work/service-account.json ]; then
            echo "❌ Erro: Falha ao criar arquivo service-account.json"
            exit 1
          fi
          
          # Verificar se contém campos obrigatórios
          if ! grep -q '"type"' /home/runner/work/service-account.json || ! grep -q '"project_id"' /home/runner/work/service-account.json; then
            echo "❌ Erro: JSON da service account parece estar incompleto"
            exit 1
          fi
          
          echo "✅ Service account JSON validado e salvo com sucesso"
        env:
          GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}

      - name: Criar config do rclone (Drive via Service Account)
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << 'EOF'
          [gdrive]
          type = drive
          scope = drive
          service_account_file = /home/runner/work/service-account.json
          # root_folder_id aponta a pasta que você compartilhou
          root_folder_id = 1F22HTbcjiLDcIlVWnEqOn3JRgznWZ80K
          EOF

      - name: Sincronizar do Drive para pasta local
        run: |
          mkdir -p images

          # Sincronizar imagens e outros arquivos do Google Drive
          # O rclone baixa arquivos nativos (imagens, PDFs, etc.) diretamente
          # Para Google Docs/Sheets, pode exportar se necessário
          EXPORTS="png,jpg,jpeg,gif,webp,pdf,svg"

          rclone sync gdrive: images \
            --drive-root-folder-id "1F22HTbcjiLDcIlVWnEqOn3JRgznWZ80K" \
            --drive-export-formats "${EXPORTS}" \
            --create-empty-src-dirs \
            --checksum \
            --fast-list \
            --transfers=8 \
            --checkers=16 \
            --verbose \
            --progress

      - name: Normalizar permissões (evita ruído no git)
        run: |
          git config core.fileMode false

      - name: Commit e push (se houver mudanças)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            TS=$(date -u +"%Y-%m-%d %H:%M:%SZ")
            git commit -m "chore: sync do Google Drive → repo (${TS})"
            git push
          else
            echo "Sem mudanças para comitar."
          fi

